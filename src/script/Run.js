// ==UserScript==
// @name         Sandau-ÈÄâËØæÂ∞èÂä©Êâã
// @namespace    http://tampermonkey.net/
// @version      2024.1.0.0
// @description  Áî®‰∫éËá™Âä®ÈÄâËØæÊó∂ÔºåÁî®Êà∑ÂèØ‰ª•ÈÄöËøáËæìÂÖ•ËØæÁ®ãID„ÄÅÈ°µÊï∞ÂíåÊó∂Èó¥Êù•ËøõË°åËá™Âä®Êìç‰Ωú„ÄÇËøô‰∏™ËÑöÊú¨Êó®Âú®ÁÆÄÂåñÁî®Êà∑ÁöÑÈÄâËØæÊµÅÁ®ãÔºåÊèê‰æõ‰∫ÜÊõ¥‰æøÊç∑ÁöÑÈÄâËØæ‰ΩìÈ™å„ÄÇ
// @author       QiliChen
// @match        https://jw.sandau.edu.cn/eams-shuju/stdElectCourse!defaultPage.action*
// @icon         https://www.sandau.edu.cn/_upload/tpl/00/65/101/template101/images/foot_l.png
// @grant        none
// @license none
// ==/UserScript==
(function() {
    'use strict';
 
 // Panel
    var panel = document.createElement('div');
    panel.style.background = '#f3f3f3';
    panel.style.border = '1px solid #ddd';
    panel.style.borderRadius = '8px';
    panel.style.padding = '10px';
    panel.style.position = 'fixed';
    panel.style.top = '10px';
    panel.style.right = '10px';
    panel.style.width = '220px';
    panel.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
    document.body.appendChild(panel);
 
    var title = document.createElement('div');
    title.textContent = 'QiliÈÄâËØæÂ∞èÂä©Êâã';
    title.style.textAlign = 'center';
    title.style.marginBottom = '12px';
    panel.appendChild(title);
    // Input for Course ID
    var input = document.createElement('input');
    input.placeholder = 'ËæìÂÖ•ËØæÁ®ãID';
    input.style.width = '100%';
    input.style.marginBottom = '10px';
    panel.appendChild(input);
 
    var pageNumberInput = document.createElement('input');
    pageNumberInput.placeholder = 'ËæìÂÖ•È°µÁ†Å(ÂèØ‰ª•‰∏∫Á©∫)';
    pageNumberInput.style.width = '100%';
    pageNumberInput.style.marginBottom = '10px';
    panel.appendChild(pageNumberInput);
 
    // Input for Time
    var timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.step = '1';
    timeInput.style.width = '100%';
    panel.appendChild(timeInput);
 
    var clearTimeButton = document.createElement('button');
    clearTimeButton.innerHTML = 'Ê∏ÖÁ©∫ÊâÄÊúâ';
    clearTimeButton.style.width = '100%';
    clearTimeButton.style.marginTop = '5px';
    panel.appendChild(clearTimeButton);
 
    // Button
    var button = document.createElement('button');
    button.innerHTML = 'Ëá™Âä®ÈÄâËØæ';
    button.style.width = '100%';
    button.style.marginTop = '10px';
    panel.appendChild(button);
 
    var countdownDisplay = document.createElement('div');
    countdownDisplay.style.marginTop = '10px';
    panel.appendChild(countdownDisplay);
 
 
    var timeToggleCheckbox = document.createElement('input');
    timeToggleCheckbox.type = 'checkbox';
    timeToggleCheckbox.checked = true;
    timeToggleCheckbox.style.marginTop = '5px';
    panel.appendChild(timeToggleCheckbox);
 
    var timeToggleLabel = document.createElement('label');
    timeToggleLabel.textContent = 'ÂêØÁî®ÂÆöÊó∂';
    timeToggleLabel.style.marginLeft = '5px';
    panel.appendChild(timeToggleLabel);
 
 
    var timeToggleContainer = document.createElement('div');
    timeToggleContainer.style.display = 'flex';
    timeToggleContainer.style.justifyContent = 'center'; // Center horizontally
    timeToggleContainer.style.alignItems = 'center'; // Center vertically
    timeToggleContainer.style.marginBottom = '10px';
 
    timeToggleContainer.appendChild(timeToggleCheckbox);
    timeToggleContainer.appendChild(timeToggleLabel);
    panel.appendChild(timeToggleContainer);
 
 
 
    input.value = localStorage.getItem('savedCourseId') || '';
    timeInput.value = localStorage.getItem('savedTime') || '';
 
    var savedTimerTime = localStorage.getItem('savedTimerTime');
    if (savedTimerTime) {
        var savedDateTime = new Date(savedTimerTime);
        if (savedDateTime > new Date()) {
            startCountdown(savedDateTime, input.value.trim());
        }
    }
 
    var togglePanelButton = document.createElement('button');
    togglePanelButton.innerHTML = 'üëâüèª'; // Arrow symbol indicating collapse
    togglePanelButton.style.position = 'absolute';
    togglePanelButton.style.top = '0';
    togglePanelButton.style.right = '100%'; // Position to the left of the panel
    panel.appendChild(togglePanelButton);
 
    var isPanelCollapsed = false;
    var countdown;
 
    togglePanelButton.addEventListener('click', function() {
        if (isPanelCollapsed) {
            // Expand the panel
            panel.style.width = '220px';
            input.style.display = 'block';
            timeInput.style.display = timeToggleCheckbox.checked ? 'block' : 'none';
            clearTimeButton.style.display = timeToggleCheckbox.checked ? 'block' : 'none';
            button.style.display = 'block';
            countdownDisplay.style.display = 'block';
            timeToggleCheckbox.style.display = 'block';
            timeToggleLabel.style.display = 'block';
            pageNumberInput.style.display = 'block';
            togglePanelButton.innerHTML = 'üëâüèª';
        } else {
            // Collapse the panel
            panel.style.width = '20px';
            input.style.display = 'none';
            timeInput.style.display = 'none';
            clearTimeButton.style.display = 'none';
            button.style.display = 'none';
            countdownDisplay.style.display = 'none';
            timeToggleCheckbox.style.display = 'none';
            timeToggleLabel.style.display = 'none';
            pageNumberInput.style.display = 'none';
            togglePanelButton.innerHTML = 'üëàüèª';
        }
        isPanelCollapsed = !isPanelCollapsed;
    });
 
        // Toggle functionality
    timeToggleCheckbox.addEventListener('change', function() {
        if (timeToggleCheckbox.checked) {
            timeInput.style.display = 'block';
        } else {
            timeInput.style.display = 'none';
            timeInput.value = ''; // Clear the time input
            countdownDisplay.textContent = ''; // Clear countdown display
        }
    });
 
    button.addEventListener('click', function() {
        var courseId = input.value.trim();
        var startTime = timeInput.value;
        var pageNumber = pageNumberInput.value;
        localStorage.setItem('savedCourseId', courseId);
        localStorage.setItem('savedTime', startTime);
        localStorage.setItem('savedPageNumber', pageNumber);
        clearInterval(countdown);
        if (courseId) {
            if (startTime) {
                var startDateTime = new Date();
                var timeParts = startTime.split(':');
                startDateTime.setHours(timeParts[0], timeParts[1], timeParts[2] || 0);
                localStorage.setItem('savedTimerTime', startDateTime.toString());
 
 
                var now = new Date();
                var delay = startDateTime.getTime() - now.getTime();
 
                if (delay < 0) {
                    countdownDisplay.textContent = 'ÊâÄÈÄâÊó∂Èó¥Â∑≤ËøáÔºåËØ∑ÈÄâÊã©Êú™Êù•ÁöÑÊó∂Èó¥„ÄÇ';
                    return;
                }
                startCountdown(startDateTime, courseId);
 
            } else {
                localStorage.setItem('globalNumber', 3);
                localStorage.removeItem('savedTime');
                countdownDisplay.textContent = '';
                trySelectCourse(courseId);
            }
        }
    });
        // Âú®ÂÄíËÆ°Êó∂ÁªìÊùüÂêéÊâßË°åÊä¢ËØæÊìç‰Ωú
    function startCountdown(startDateTime, courseId) {
        countdown = setInterval(function() {
            var now = new Date();
            var remaining = startDateTime.getTime() - now.getTime();
 
            if (remaining <= 1) {
                clearInterval(countdown);
                countdownDisplay.textContent = 'ÂêØÂä®ÊàêÂäü...';
                // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÂêéÂà∑Êñ∞È°µÈù¢
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                localStorage.setItem('globalNumber', 3);
                var seconds = Math.floor(remaining / 1000);
                countdownDisplay.textContent = 'Ëá™Âä®ËÑöÊú¨ËøòÂâ©: ' + seconds + 'sÊâßË°å';
            }
        }, 1000);
    }
        window.addEventListener('load', function() {
            clearInterval(countdown);
            openEnterCourseSelection();
            if (window.location.href.startsWith('https://jw.sandau.edu.cn/eams-shuju/stdElectCourse!defaultPage.action?electionProfile.id=')) {
            var courseId = localStorage.getItem('savedCourseId');
            if (courseId) {
                trySelectCourse(courseId);
                localStorage.removeItem('savedTime');
            }
        }
        });
 
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
 
    async function selectCourse(courseId) {
        var rows = document.querySelectorAll('#electableLessonList tr');
        var found = false;
 
        for (const row of rows) {
            var currentId = row.cells[1] ? row.cells[1].textContent.trim() : '';
            if (currentId === courseId) {
                found = true;
                var electLink = row.querySelector('a.lessonListOperator');
                if (electLink) {
                    electLink.click();
                    console.log('Â∞ùËØïÈÄâËØæ');
                    await sleep(800);
                    var outerDiv = document.getElementById('cboxLoadedContent');
                    if (outerDiv) {
                        var errorText = outerDiv.textContent.trim();
                        console.log(errorText);
                        if (!errorText.includes('Êä¢ËØæÊàêÂäü')) {
                            var closeButton = document.getElementById('cboxClose');
                            if (closeButton) {
                                closeButton.click();
                            }
                        }
                    } else {
                        console.log('Êú™ÊâæÂà∞ÁâπÂÆö ID ÂÖÉÁ¥†');
                    }
 
                }
            }
        }
 
        return found;
    }
 
    function openEnterCourseSelection() {
        if (window.location.href === 'https://jw.sandau.edu.cn/eams-shuju/stdElectCourse.action') {
            var savedCourseId = localStorage.getItem('savedCourseId');
            if (savedCourseId) { // Ê£ÄÊü• savedCourseId ÊòØÂê¶Â≠òÂú®‰∏î‰∏ç‰∏∫Á©∫
                var enterButtons = document.querySelectorAll("button[onclick*='/eams-shuju/stdElectCourse!defaultPage.action']");
                var lastEnterButton = enterButtons[enterButtons.length - 1];
                if (lastEnterButton && lastEnterButton.innerText === 'ËøõÂÖ•ÈÄâËØæ') {
                    lastEnterButton.click();
                }
            }
        }
    }
    function clickPageNumber(pageNumber) {
    var paginationLinks = document.querySelectorAll('.pgButton');
    for (const link of paginationLinks) {
        if (link.getAttribute('pageno') === pageNumber) {
            link.click();
            break;
        }
    }
    }
 
    clearTimeButton.addEventListener('click', function() {
        // Ê∏ÖÈô§ÂéüÂÖàËÆæÁΩÆÁöÑËÆ°Êó∂Âô®
        clearInterval(countdown);
 
        // Ê∏ÖÁ©∫ LocalStorage ‰∏≠ÁöÑÊï∞ÊçÆ
        localStorage.removeItem('savedCourseId');
        localStorage.removeItem('savedPageNumber');
        localStorage.removeItem('savedTime');
        input.value = '';
        timeInput.value = '';
        countdownDisplay.textContent = '';
        pageNumberInput.value = '';
    });
 
    async function trySelectCourse(courseId) {
        var savedPageNumber = localStorage.getItem('savedPageNumber');
        if (savedPageNumber) {
            clickPageNumber(savedPageNumber);
        }
        var found = await selectCourse(courseId);
        if (!found) {
            console.log('Êú™ÊâæÂà∞ËØ•ËØæÁ®ãID: ' + courseId);
            countdownDisplay.textContent = 'Êú™ÊâæÂà∞ËØ•ËØæÁ®ãID: ' + courseId;
            return;
        }else{
            for (var i = 1; i < 3; i++) {
                await sleep(500);
                await selectCourse(courseId);
            }
            var outerDiv = document.getElementById('cboxLoadedContent');
            var errorText = outerDiv.textContent.trim();
            console.log(errorText);
            var savedGlobalNumber = localStorage.getItem('globalNumber');
            if (!errorText.includes('Êä¢ËØæÊàêÂäü')) {
                console.log('ËøõÂÖ•Êù°‰ª∂');
                console.log('savedGlobalNumber:', savedGlobalNumber);
 
                if (savedGlobalNumber !== '1') {
                    console.log('ÊâßË°åÊù°‰ª∂ÂÜÖÈÉ®');
                    savedGlobalNumber--;
                    console.log('savedGlobalNumber after decrement:', savedGlobalNumber);
                    localStorage.setItem('globalNumber', savedGlobalNumber);
                    location.reload();
                    return;
                }
            }
            localStorage.removeItem('globalNumber');
            localStorage.removeItem('savedPageNumber');
            localStorage.removeItem('savedCourseId');
            timeInput.value = '';
            countdownDisplay.textContent = '';
 
        }
 
    }
})();